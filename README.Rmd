---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# KOMAP

<!-- badges: start -->
<!-- badges: end -->

The goal of KOMAP is to fit an unsupervised phenotyping system which does not require manual chart review to acquire gold standard labels for algorithm training and validation. The online algorithm only requires summary-level covariance matrix for coefficient training. To get a quick model evaluation without individual-level data, users can upload conditional mean vector and covariance matrix to obtain a simulated model AUC. KOMAP can deal with cases when both codified and NLP features are available, or when only one feature type is at hand (just leave `target.code` or `target.cui` equal to `NULL` if not available). 

## Installation

You can install the development version of KOMAP from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("xinxiong0238/KOMAP")
```

## Example

This is a basic example of how to use the main function in the KOMAP package to perform model training, score prediction and model evaluation with built-in toy rheumatoid arthritis data. To do phenotyping on other diseases, you should specify the related codified features and/or NLP features either with prior knowledge or with ONCE searching results (https://shiny.parse-health.org/CUIsearch-dev/). The csv file you downloaded from ONCE app has the same format as `codify_RA` (or `cui_RA`) stored in the KOMAP pacakge.

```{r example}
library(KOMAP)
codify.feature <- codify_RA$Variable[codify_RA$select == 1]
cuisearch.feature <- cui_RA$cui[cui_RA$select == 1]
input.cov <- cov_RA
target.code <- 'PheCode:714.1'
target.cui <- 'C0003873'
nm.utl <- 'utl'
nm.pi <- 'pi'
nm.id <- 'patient_num'
nm.y <- 'Y'
dat.part <- dat_part
gold.label <- gold_label

## Only fit the model without any validation and without feature screening
out_0 <- KOMAP(input.cov, target.code, target.cui, nm.utl, nm.multi = NULL, dict_RA,
             pred = FALSE, eval.real = FALSE, eval.sim = FALSE)

## Only fit the model without any validation
out_1 <- KOMAP(input.cov, target.code, target.cui, nm.utl, nm.multi = NULL, dict_RA,
             codify.feature, cuisearch.feature,               
             pred = FALSE, eval.real = FALSE, eval.sim = FALSE)

## Fit the model and calculate simulated AUC
out_2 <- KOMAP(input.cov, target.code, target.cui, nm.utl, nm.multi = NULL, dict_RA,
             codify.feature, cuisearch.feature,               
             pred = FALSE, eval.real = FALSE, eval.sim = TRUE,
             mu0, mu1, var0, var1, prev_Y, B = 10000)

## If individual data is provided, KOMAP can perform disease score prediction
out_3 <- KOMAP(input.cov, target.code, target.cui, nm.utl, nm.multi = NULL, dict_RA,
             codify.feature, cuisearch.feature,               
             pred = TRUE, eval.real = FALSE, eval.sim = FALSE,
             dat.part = dat.part, nm.id = nm.id)

## If individual data and gold label are provided, KOMAP can perform disease score prediction and calculate the true AUC
out_4 <- KOMAP(input.cov, target.code, target.cui, nm.utl, nm.multi = NULL, dict_RA,
             codify.feature, cuisearch.feature,               
             pred = TRUE, eval.real = TRUE, eval.sim = FALSE,
             dat.part = dat.part, nm.id = nm.id, 
             gold.label = gold.label, nm.pi = nm.pi, nm.y = nm.y)
```
